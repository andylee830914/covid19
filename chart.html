<html>

<head>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/Chart.min.css">
    <link rel="stylesheet" href="css/app.css">

    <script src="js/jquery.min.js"></script>
    <script src="js/popper.min.js"></script>
    <!-- <script src="js/Chart.bundle.min.js"></script> -->
    <script src="js/bootstrap.min.js"></script>

    <script src="js/Chart.min.js"></script>
    <script src="js/chartjs-plugin-zoom.js"></script>


    <!-- Latest compiled and minified JavaScript -->
    <title>Group Testing for COVID-19</title>
    <style>
        .pool-inner {
            border-radius: 30px;
            width: calc(100% - 10px);
            height: calc(100% - 10px);
            border-style: solid;
            border-width: 1px;
            margin: 5px;

        }

        .pool-grid {
            /* border-style: solid; */
            width: calc(100% - 20px);
            height: calc(100% - 20px);
            border-width: 0px;
            margin: 10px;
            display: grid;
            grid-column-gap: 5px;
            grid-template-columns: auto auto auto auto auto;
            justify-content: center;
            align-content: space-around;
        }

        .pool-outer {
            width: 250px;
            height: 250px;
            border-style: solid;
            border-width: 1px;
            margin: 20px;
            float: left;
        }

        .grid {
            border-radius: 25pt;
            width: 25px;
            height: 25px;
            border-width: 1px;
            border-style: solid;
            justify-content: space-around;
            text-align: center;
            vertical-align: middle;
        }

        .caption {
            text-align: center;
        }

        .row {
            padding-bottom: 20px;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
        <a class="navbar-brand" href="#">Group Testing for COVID-19</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item">
                    <a class="nav-link" href="index.html">Introduction</a>
                </li>
                <li class="nav-item active">
                    <a class="nav-link" href="chart.html">Simulation <span class="sr-only">(current)</span></a>
                </li>
            </ul>
        </div>
    </nav>
    <main role="main" class="container">
        <div class="row">
            <div class="col-9">
                <div id="platplot" style="display: none;">
                    <div id="plates" class="row">
                        <div class="pool-outer" style="display: none;" id="pool1">
                            <div class="pool-inner">
                                <div class="pool-grid">

                                </div>
                            </div>
                            <div class="caption">Plate 1(◎ patients)</div>
                        </div>
                    </div>
                    <div class="row">
                        <div id="positive">
                            <div class="pool-outer" style="display: none;" id="ppool">
                                <div class="pool-inner">
                                    <div class="pool-grid">

                                    </div>
                                </div>
                                <div class="caption">Number of Positive Tests</div>
                            </div>
                        </div>
                        <div id="patient">
                            <div class="pool-outer" style="display: none;" id="ppatient">
                                <div class="pool-inner">
                                    <div class="pool-grid">

                                    </div>
                                </div>
                                <div class="caption">Positive Patients</div>
                            </div>
                        </div>
                        <div id="text_output">
                            <div class="pool-outer card">
                                <div class="card-body" id="opt-GT" style="padding: 1rem;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="dashboard_new" class="dashboard jumbotron">
                    <div class="row plot_title">
                        <div class="d-flex flex-fill align-items-center">
                            <h6>Summary</h6>
                        </div>
                        <div class="d-flex flex-column justify-content-end align-items-end">

                        </div>
                    </div>
                    <canvas id="new_plot"></canvas>
                </div>
                <div id="dashboard_compare" class="dashboard jumbotron" style="display: none;">
                    <div class="row plot_title">
                        <div class="d-flex flex-fill align-items-center">
                            <h6>Summary</h6>
                        </div>
                        <div class="d-flex flex-column justify-content-end align-items-end">

                        </div>
                    </div>
                    <canvas id="compare_plot1"></canvas>
                    <canvas id="compare_plot2"></canvas>
                    <canvas id="compare_plot3"></canvas>
                </div>
                <div id="compare2" style="display: none;">
                    <div id="opt-Comp"></div>

                </div>
            </div>
            <div class="col-3">
                <form>
                    <div class="form-group">Enter the method: <font color=red><span id="opt-method"></span></font><br>
                        <div class="form-check form-check-inline">
                            <input name="method_selected" id="method-1" type="radio" required>
                            <label class="form-check-label" for="method-1">Dorfman</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input name="method_selected" id="method-2" type="radio" required>
                            <label class="form-check-label" for="method-2">2-Grid</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input name="method_selected" id="method-3" type="radio" required checked>
                            <label class="form-check-label" for="method-3">3-Grid</label>
                        </div>
                    </div>
                    <div class="form-group">Infection level (p): <font color=red><span id="opt-p"></span></font><br>
                        <input name="range-p" id="var-p" value="40" type="range" class="form-control-range" min="1"
                            max="1000" />
                    </div>
                    <div class="form-group">Pool size (w): <font color=red><span id="opt-N"></span></font><br>
                        <input name="range-N" id="var-N" value="5" type="range" class="form-control-range" min="3"
                            max="32" />
                    </div>
                    <!--
                    <div class="form-group">Enter the number of tests (K): <font color=red><span id="opt-K"></span></font><br>
                        <input name="range-K" id="var-K" value="1" type="range" class="form-control-range" min="1" max="1000" />
                    </div>
					-->
                    <div class="form-group">
                        Sensitivity of Single Test: <font color=red><span id="opt-TPR"></span></font><br>
                        <input name="range-TPR" value="98" id="var-TPR" type="range" class="form-control-range" min="0"
                            max="100" />
                    </div>
                    <div class="form-group">
                        Sensitivity of Group Test: <font color=red><span id="opt-GTPR"></span></font><br>
                        <input name="range-GTPR" id="var-GTPR" value="90" type="range" class="form-control-range"
                            min="0" max="100" />
                    </div>
                    <div class="form-group">
                        Specificity of Single Test: <font color=red><span id="opt-TNR"></span></font><br>
                        <input name="range-TNR" value="100" id="var-TNR" type="range" class="form-control-range" min="0"
                            max="100" />
                    </div>
                    <div class="form-group">
                        Specificity of Group Test: <font color=red><span id="opt-GTNR"></span></font><br>
                        <input name="range-GTNR" id="var-GTNR" value="100" type="range" class="form-control-range"
                            min="0" max="100" />
                    </div>
                    <div class="form-group">
                        Number of confirm cases: <font color=red><span id="opt-NCC"></span></font><br>
                        <input name="v-confirmcase" id="var-NCC" value="57731" type="input"
                            class="form-control" />
                    </div>
                    <div class="form-group">
                        Number of tests: <font color=red><span id="opt-NTS"></span></font><br>
                        <input name="v-tests" id="var-NTS" value="344409" type="input" class="form-control" />
                    </div>

                </form>

                <div class="btn-group-vertical">
                    <input type="button" value="Test Once" class="btn btn-outline-primary" onclick="test_once(1)">
                    <!--
				<input type="button" value="Two-Way Group Test" class="btn btn-outline-primary" onclick="Group_Test_2W()">
                <input type="button" value="Three-Way Group Test" class="btn btn-outline-primary" onclick="Group_Test_3W()">
                -->
                    <input type="button" value="Summary" class="btn btn-outline-primary" onclick="Summary()">
                    <input type="button" value="Comparison" class="btn btn-outline-primary"
                        onclick="Methods_Comparison()">
                    <input type="button" value="Comparison 2" class="btn btn-outline-primary"
                        onclick="Methods_Comparison2()">
                </div>
            </div>
        </div>
        <!-- <span id="opt-GD"></span><br><span id="opt-G"></span><br> -->
        <!-- <span id="opt-GT1"></span><br>
        <span id="opt-GT2"></span><br>
        <span id="opt-GT3"></span> -->

    </main>

</body>

<script>
    var cprofile1 = ["#0000ff", "#00ffff", "#00ff00", "#ffff00", "#ff0000"]
    var cprofile2 = ["#112F41", "#0894A1", "#47AB6C", "#F2B134", "#ED553B"]
    var cprofile3 = ["#955BA5", "#2D95BF", "#4EBA6F", "#F0C419", "#F15A5A"]
    var pcolor = [["#C8E1B8", "#F28774"], ["#C8E1B8", "#FCD9D5", "#F28774"], ["#C8E1B8", "#FCD9D5", "#F9BDB2", "#F28774"]]
    var ppatcolor = ["#20B157", "#D04753"]

    var cprofile = cprofile3;
    var total_line = [];

    var ctx1 = document.getElementById('new_plot').getContext('2d');
    var comp1 = document.getElementById('compare_plot1').getContext('2d');
    var comp2 = document.getElementById('compare_plot2').getContext('2d');
    var comp3 = document.getElementById('compare_plot3').getContext('2d');
    var scatterChart;
    var compareChart = [];

    $(document).ready(function () {
        scatterChart = createPlot(ctx1, 'Infection level (p)', 'Ratio', '');
        compareChart[0] = createPlot(comp1, 'Infection level (p)', 'Usage Ratio', 'Usage Ratio');
        compareChart[1] = createPlot(comp2, 'Infection level (p)', 'Sensitivity', 'Sensitivity');
        compareChart[2] = createPlot(comp3, 'Infection level (p)', 'Specificity', 'Specificity');
        $("#new_plot").dblclick(function () {
            scatterChart.resetZoom();
        });
        $("#compare_plot1").dblclick(function () {
            compareChart[0].resetZoom();
        });
        $("#compare_plot2").dblclick(function () {
            compareChart[1].resetZoom();
        });
        $("#compare_plot3").dblclick(function () {
            compareChart[2].resetZoom();
        });
    });

    function createPlot(context, x_label, y_label, title) {
        var newchart = new Chart(context, {
            type: 'scatter',
            options: {
                scales: {
                    xAxes: [{
                        scaleLabel: {
                            display: true,
                            labelString: x_label
                        },
                        type: 'linear',
                        position: 'bottom'
                    }],
                    yAxes: [{
                        scaleLabel: {
                            display: true,
                            labelString: y_label
                        },
                        type: 'linear',
                        position: 'left'
                        //ticks: {
                        //    max: 1,
                        //    min: 0,
                        //    stepSize: 0.1
                        //}
                    }]
                },
                title: {
                    display: (title ? true : false),
                    text: title
                },
                plugins: {
                    zoom: {
                        // Container for pan options
                        pan: {
                            // Boolean to enable panning
                            enabled: true,
                            mode: 'xy',

                            rangeMin: {
                                // Format of min pan range depends on scale type
                                x: null,
                                y: null
                            },
                            rangeMax: {
                                // Format of max pan range depends on scale type
                                x: null,
                                y: null
                            },
                        },

                        // Container for zoom options
                        zoom: {
                            // Boolean to enable zooming
                            enabled: true,
                            // Enable drag-to-zoom behavior
                            drag: true,
                            // Drag-to-zoom rectangle style can be customized
                            drag: {
                                borderColor: 'rgba(0,0,0,1)',
                                borderWidth: 0.5,
                                backgroundColor: 'rgb(225,225,225,0)'
                            },

                            mode: 'xy',
                            rangeMin: {
                                // Format of min zoom range depends on scale type
                                x: null,
                                y: null
                            },
                            rangeMax: {
                                // Format of max zoom range depends on scale type
                                x: null,
                                y: null
                            },

                            // Speed of zoom via mouse wheel
                            // (percentage of zoom on a wheel event)
                            speed: 1,
                        }
                    }
                }
            }
        });
        total_line[newchart.id] = []
        return newchart;
    }

    function addData(chart, label, data) {
        var line_id = total_line[chart.id].length
        var index = chart.data.datasets.push(
            {
                label: label,
                data: data,
                pointRadius: 2,
                showLine: true,
                fill: false,
                borderColor: cprofile[line_id % 5]
            });
        chart.update();
        return index;
    }

    function updateData(chart, label, data) {
        chart.data.datasets[label].data = data;
        chart.update();
    }

    function plotData(chart, label, data) {
        if (total_line[chart.id].indexOf(label) != -1) {
            updateData(chart, total_line[chart.id].indexOf(label), data);
        } else {
            addData(chart, label, data);
            total_line[chart.id].push(label);
        }
    }


</script>
<script type="text/javascript">
    var maxN = 40;
    var method_radio = document.getElementsByName("method_selected");
    var mrad1 = document.getElementById("method-1");
    var mrad2 = document.getElementById("method-2");
    var mrad3 = document.getElementById("method-3");
    var method_selected;
    var slider_p = document.getElementById("var-p");
    var slider_N = document.getElementById("var-N");
    slider_N.max = maxN - 1;
    //var slider_K = document.getElementById("var-K");
    var slider_TPR = document.getElementById("var-TPR");
    var slider_GTPR = document.getElementById("var-GTPR");
    slider_GTPR.max = slider_TPR.value;
    var slider_TNR = document.getElementById("var-TNR");
    var slider_GTNR = document.getElementById("var-GTNR");
    slider_GTNR.max = slider_TNR.value;
    var p = Number(slider_p.value) / Number(slider_p.max);
    var N = Number(slider_N.value);
    var K = 1000;//Number(slider_K.value);
    var TPR = Number(slider_TPR.value) / 100.0;
    var GTPR = Number(slider_GTPR.value) / 100.0;
    var TNR = Number(slider_TNR.value) / 100.0;
    var GTNR = Number(slider_GTNR.value) / 100.0;
    var GTTPR, GTTNR, GTRat;

    for (var i = 0; i < method_radio.length; ++i) {
        if (method_radio[i].checked) {
            method_selected = i + 1;
            break;
        }
    }

    var G = new Array(maxN);
    for (var i = 0; i < G.length; ++i) {
        G[i] = new Array(maxN);
    }
    var H = new Array(maxN);
    for (var i = 0; i < H.length; ++i) {
        H[i] = new Array(maxN);
    }
    var X = new Array(maxN);
    for (var i = 0; i < X.length; ++i) {
        X[i] = new Array(maxN);
    }
    var Diag = new Array(maxN);

    document.getElementById("opt-method").innerHTML = method_selected;
    document.getElementById("opt-p").innerHTML = p;
    document.getElementById("opt-N").innerHTML = N;
    //document.getElementById("opt-K").innerHTML = K;
    document.getElementById("opt-TPR").innerHTML = Number(slider_TPR.value) + "%";
    document.getElementById("opt-GTPR").innerHTML = Number(slider_GTPR.value) + "%";
    document.getElementById("opt-TNR").innerHTML = Number(slider_TNR.value) + "%";
    document.getElementById("opt-GTNR").innerHTML = Number(slider_GTNR.value) + "%";

    //var maxTime = 1; // seconds
    //var time = maxTime;
    var idleStart = false;
    //$('body').on('keydown mousemove mousedown', function(e) {
    //    time = maxTime; // reset
    //});
    var intervalId = setInterval(function () {
        //time--;
        //if (time <= 0) {
        if (idleStart == true) {
            Summary();
            idleStart = false;
        }
        //}
    }, 1000);

    mrad1.oninput = function () {
        for (var i = 0; i < method_radio.length; ++i) {
            if (method_radio[i].checked) {
                method_selected = i + 1;
                break;
            }
        }
        document.getElementById("opt-method").innerHTML = method_selected;
    }
    mrad2.oninput = function () {
        for (var i = 0; i < method_radio.length; ++i) {
            if (method_radio[i].checked) {
                method_selected = i + 1;
                break;
            }
        }
        document.getElementById("opt-method").innerHTML = method_selected;
    }
    mrad3.oninput = function () {
        for (var i = 0; i < method_radio.length; ++i) {
            if (method_radio[i].checked) {
                method_selected = i + 1;
                break;
            }
        }
        document.getElementById("opt-method").innerHTML = method_selected;
    }

    slider_p.oninput = function () {
        p = Number(slider_p.value) / Number(slider_p.max);
        N = Math.floor(Math.sqrt(1.0 / p));
        if (N < 4) N = 4;
        slider_N.value = N;
        document.getElementById("opt-N").innerHTML = N;
        document.getElementById("opt-p").innerHTML = p;
        //Group_Test();
        idleStart = false;
    }
    slider_N.oninput = function () {
        N = Number(slider_N.value);
        //var Np = Math.floor(Number(slider_p.max) / N / N);
        //p = Np / Number(slider_p.max);
        //slider_p.value = Np;
        //document.getElementById("opt-p").innerHTML = p;
        document.getElementById("opt-N").innerHTML = N;
        //Group_Test();
        idleStart = false;
    }
	/*
    slider_K.oninput = function () {
        K = Number(slider_K.value);
        document.getElementById("opt-K").innerHTML = Number(slider_K.value);
        Group_Test_3W();
        idleStart  = false;
    }
	*/
    slider_TPR.oninput = function () {
        TPR = Number(slider_TPR.value) / 100.0;
        slider_GTPR.max = slider_TPR.value;
        document.getElementById("opt-TPR").innerHTML = Number(slider_TPR.value) + "%";
        document.getElementById("opt-GTPR").innerHTML = Number(slider_GTPR.value) + "%";
        Group_Test();
        idleStart = true;
    }
    slider_GTPR.oninput = function () {
        GTPR = Number(slider_GTPR.value) / 100.0;
        document.getElementById("opt-GTPR").innerHTML = Number(slider_GTPR.value) + "%";
        Group_Test();
        idleStart = true;
    }
    slider_TNR.oninput = function () {
        TNR = Number(slider_TNR.value) / 100.0;
        slider_GTNR.max = slider_TNR.value;
        document.getElementById("opt-TNR").innerHTML = Number(slider_TNR.value) + "%";
        document.getElementById("opt-GTNR").innerHTML = Number(slider_GTNR.value) + "%";
        Group_Test();
        idleStart = true;
    }
    slider_GTNR.oninput = function () {
        GTNR = Number(slider_GTNR.value) / 100.0;
        document.getElementById("opt-GTNR").innerHTML = Number(slider_GTNR.value) + "%";
        Group_Test();
        idleStart = true;
    }

    function generate(opt) {
        var i, j;

        for (i = 0; i < N; ++i) {
            for (j = 0; j < N; ++j) {
                if (Math.random() < p) {
                    G[i][j] = 1;
                } else {
                    G[i][j] = 0;
                }
            }
            G[i][N] = 0;//'N';
        }
        for (j = 0; j < N; ++j) {
            G[N][j] = 0;//'N';
        }
        if (opt == 1) output_grid(0);
        return;
    }
    function test_once(opt) {
        p = Number(slider_p.value) / Number(slider_p.max);
        N = Number(slider_N.value);
        $("#platplot").show();
        $("#dashboard_new").hide();
        $("#dashboard_compare").hide();
        $("#compare2").hide();

        var Kold = K;
        K = 1;
        $("#pool2").remove();
        $("#pool3").remove();
        if (method_selected == 1) {
            Group_Test_1W();
        } else if (method_selected == 2) {
            $("#pool1").clone().attr('id', 'pool2').insertAfter("#pool1").children('.caption').html('Plate 2(◎ patients)');
            Group_Test_2W();

        } else {
            $("#pool1").clone().attr('id', 'pool2').insertAfter("#pool1").children('.caption').html('Plate 2(◎ patients)');
            $("#pool1").clone().attr('id', 'pool3').insertAfter("#pool2").children('.caption').html('Plate 3(◎ patients)');
            Group_Test_3W();

        }
        K = Kold;
        return;
    }

    function output_grid(Show_Test) {
        var i, j, s = "<table><tr>";
        $(".pool-grid").html('').css('grid-template-columns', 'auto '.repeat(N));
        $(".pool-outer").width(N * 25 + (N + 1) * 5 + 20);
        $(".pool-outer").height(N * 25 + (N + 1) * 5 + 20).show();

        for (i = 0; i < N; ++i) {
            for (j = 0; j < N; ++j) {
                s = s + "<td width='14pt'>" + String(G[i][j]) + "</td>";
                if (G[i][j]) {
                    var ptext = '◎';
                } else {
                    var ptext = '';
                }
                $(".pool-grid").append('<div class="grid">' + ptext + '</div>');

            }
            if (Show_Test >= 2) {
                if (G[i][N] == 1) {
                    s = s + "<td>P</td>";
                    for (j = 0; j < N; ++j) {
                        $("#pool1").find('.pool-grid').children('div:nth-child(' + String(i * N + j + 1) + ')').css('background-color', "#FCD9D5")
                    }
                } else {
                    s = s + "<td>N</td>";
                }
            }
            s = s + "</tr>";
        }
        if (Show_Test == 1) {
            if (G[N][0] == 1) {
                $("#pool1").find('.pool-grid').children().css('background-color', "#FCD9D5")
            }
        }

        if (Show_Test >= 2) {
            s = s + "<tr>";
            for (j = 0; j < N; ++j) {
                if (G[N][j] == 1) {
                    s = s + "<td>P</td>";
                    for (i = 0; i < N; ++i) {
                        $("#pool2").find('.pool-grid').children('div:nth-child(' + String(i * N + j + 1) + ')').css('background-color', "#FCD9D5")
                    }
                } else {
                    s = s + "<td>N</td>";
                }
            }
            s = s + "</tr>";
        }
        s = s + "</table>";

        if (Show_Test >= 1) {
            $("#ppool").show();
            s = s + "<br>Number of Postive Tests:<br><table><tr>";
            for (i = 0; i < N; ++i) {
                for (j = 0; j < N; ++j) {
                    // s = s + "<td width='14pt'>" + String(X[i][j]) + "</td>";
                    $("#ppool").find('.pool-grid').children('div:nth-child(' + String(i * N + j + 1) + ')').css('background-color', pcolor[Show_Test - 1][X[i][j]]).html(String(X[i][j]))
                }
                s = s + "</tr>";
            }
            s = s + "</table>";
        }


        if (Show_Test >= 1) {
            s = s + "<br>Positive Patients:<br><table><tr>";
            for (i = 0; i < N; ++i) {
                for (j = 0; j < N; ++j) {
                    // s = s + "<td width='14pt'>" + String(H[i][j]) + "</td>";
                    $("#ppatient").find('.pool-grid').children('div:nth-child(' + String(i * N + j + 1) + ')').css('background-color', ppatcolor[H[i][j]])
                }
                s = s + "</tr>";
            }
        }
        s = s + "</table>";


        // document.getElementById("opt-G").innerHTML = s;

        if (Show_Test >= 3) {
            s = "Diagonal Test Result(i-j=0,1,2,...,N-1):";
            for (i = 0; i < N; ++i) {
                if (Diag[i] == 1) {
                    s = s + "P";
                } else {
                    s = s + "N";
                }
            }
            // document.getElementById("opt-GD").innerHTML = s;
            for (i = 0; i < N; ++i) {
                if (Diag[i] == 1) {
                    for (j = 0; j < N; ++j) {
                        $("#pool3").find('.pool-grid').children('div:nth-child(' + String((i + j) % N * N + j + 1) + ')').css('background-color', "#FCD9D5")
                    }

                }

            }
        }
        return;
    }
    function Group_Test() {
        if (method_selected == 1) Group_Test_1W();
        else if (method_selected == 2) Group_Test_2W();
        else Group_Test_3W();
    }

    function Group_Test_1W() {
        // Dorfman's pooling test
        var i, j, k, s, t, N_TP = 0, N_TN = 0, N_FP = 0, N_FN = 0, N_Test = 0;
        var NM = Number(slider_N.max);
        var GTEST;
        var GNTPR = GTPR;//1.0*(TPR*(NM-N)+GTPR*(N-1))/(NM-1);
        var GNTNR = GTNR;//1.0*(TNR*(NM-N)+GTNR*(N-1))/(NM-1);
        for (k = 0; k < K; ++k) {
            generate(0);
            for (i = 0; i < N; ++i) {
                for (j = 0; j < N; ++j) {
                    H[i][j] = 0;
                    X[i][j] = 0;
                }
            }
            t = 0;
            for (i = 0; i < N; ++i) {
                for (j = 0; j < N; ++j) {
                    if (G[i][j] == 1) {
                        t = 1;
                        break;
                    }
                }
                if (t == 1) break;
            }
            if (Math.random() > t * (1.0 - GNTPR) + (1 - t) * GNTNR) {
                GTEST = 1;
                G[N][0] = 1;
                for (i = 0; i < N; ++i) {
                    for (j = 0; j < N; ++j) X[i][j]++;
                }
            } else {
                GTEST = 0;
                G[N][0] = 0;
            }

            if (GTEST == 1) {
                for (i = 0; i < N; ++i) {
                    for (j = 0; j < N; ++j) {
                        t = G[i][j];
                        if (Math.random() > t * (1.0 - TPR) + (1 - t) * TNR) {
                            H[i][j] = 1;
                        } else {
                            H[i][j] = 0;
                        }
                    }
                }
                N_Test += N * N;
            }
            for (i = 0; i < N; ++i) {
                for (j = 0; j < N; ++j) {
                    if (G[i][j] == 1 && H[i][j] == 1) {
                        N_TP++;
                    } else if (G[i][j] == 1 && H[i][j] == 0) {
                        N_TN++;
                    } else if (G[i][j] == 0 && H[i][j] == 1) {
                        N_FP++;
                    } else if (G[i][j] == 0 && H[i][j] == 0) {
                        N_FN++;
                    }

                }
            }
            N_Test += 1;
        }
        if (K == 1) {
            output_grid(1);

        }
        GTTPR = 1.0 * N_TP / (N_TP + N_TN);
        GTTNR = 1.0 * N_FN / (N_FP + N_FN);
        GTRat = 1.0 * N_Test / (N * N * K);
        if (K == 1) {
            s = "Usage Ratio:<br>" + String(N_Test) + "/" + String(N * N * K) + "~" + Math.round(10000.0 * GTRat) / 100.0 + "%"
                + "<br>Sensitivity:<br>" + N_TP + "/" + (N_TP + N_TN) + "~" + Math.round(10000.0 * GTTPR) / 100.0 + "%<br>Specificity:<br>"
                + N_FN + "/" + (N_FP + N_FN) + "~" + Math.round(10000.0 * GTTNR) / 100.0 + "%<br>";
            document.getElementById("opt-GT").innerHTML = s;
        }
        return;
    }
    function Group_Test_2W() {
        var i, j, k, s, t, N_TP = 0, N_TN = 0, N_FP = 0, N_FN = 0, N_Test = 0;
        var NM = Number(slider_N.max);
        var GNTPR = GTPR;//1.0*(TPR*(NM-N)+GTPR*(N-1))/(NM-1);
        var GNTNR = GTNR;//1.0*(TNR*(NM-N)+GTNR*(N-1))/(NM-1);
        for (k = 0; k < K; ++k) {
            generate(0);
            for (i = 0; i < N; ++i) {
                for (j = 0; j < N; ++j) {
                    H[i][j] = 0;
                    X[i][j] = 0;
                }
            }
            for (i = 0; i < N; ++i) {
                t = 0;
                for (j = 0; j < N; ++j) {
                    if (G[i][j] == 1) {
                        t = 1;
                        break;
                    }
                }
                if (Math.random() > t * (1.0 - GNTPR) + (1 - t) * GNTNR) {
                    G[i][N] = 1;
                    for (j = 0; j < N; ++j) X[i][j]++;
                } else {
                    G[i][N] = 0;
                }
            }
            for (j = 0; j < N; ++j) {
                t = 0;
                for (i = 0; i < N; ++i) {
                    if (G[i][j] == 1) {
                        t = 1;
                        break;
                    }
                }
                if (Math.random() > t * (1.0 - GNTPR) + (1 - t) * GNTNR) {
                    G[N][j] = 1;
                    for (i = 0; i < N; ++i) X[i][j]++;
                } else {
                    G[N][j] = 0;
                }
            }
            for (i = 0; i < N; ++i) {
                for (j = 0; j < N; ++j) {
                    if (X[i][j] == 2) {
                        t = G[i][j];
                        N_Test++;
                        if (Math.random() > t * (1.0 - TPR) + (1 - t) * TNR) {
                            H[i][j] = 1;
                        } else {
                            H[i][j] = 0;
                        }
                    } else {
                        H[i][j] = 0;
                    }
                    if (G[i][j] == 1 && H[i][j] == 1) {
                        N_TP++;
                    } else if (G[i][j] == 1 && H[i][j] == 0) {
                        N_TN++;
                    } else if (G[i][j] == 0 && H[i][j] == 1) {
                        N_FP++;
                    } else if (G[i][j] == 0 && H[i][j] == 0) {
                        N_FN++;
                    }

                }
            }
            N_Test += 2 * N;
        }
        if (K == 1) {
            output_grid(2);

        }
        GTTPR = 1.0 * N_TP / (N_TP + N_TN);
        GTTNR = 1.0 * N_FN / (N_FP + N_FN);
        GTRat = 1.0 * N_Test / (N * N * K);
        if (K == 1) {
            s = "Usage Ratio:<br>" + String(N_Test) + "/" + String(N * N * K) + "~" + Math.round(10000.0 * GTRat) / 100.0 + "%"
                + "<br>Sensitivity:<br>" + N_TP + "/" + (N_TP + N_TN) + "~" + Math.round(10000.0 * GTTPR) / 100.0 + "%<br>Specificity:<br>"
                + N_FN + "/" + (N_FP + N_FN) + "~" + Math.round(10000.0 * GTTNR) / 100.0 + "%<br>";
            document.getElementById("opt-GT").innerHTML = s;
        }
        return;
    }

    function Group_Test_3W() {
        var i, j, k, s, t, N_TP = 0, N_TN = 0, N_FP = 0, N_FN = 0, N_Test = 0;
        var NM = Number(slider_N.max);
        var GNTPR = GTPR;//1.0*(TPR*(NM-N)+GTPR*(N-1))/(NM-1);
        var GNTNR = GTNR;//1.0*(TNR*(NM-N)+GTNR*(N-1))/(NM-1);
        for (k = 0; k < K; ++k) {
            generate(0);
            for (i = 0; i < N; ++i) {
                for (j = 0; j < N; ++j) {
                    H[i][j] = 0;
                    X[i][j] = 0;
                }
            }
            for (i = 0; i < N; ++i) {
                t = 0;
                for (j = 0; j < N; ++j) {
                    if (G[i][j] == 1) {
                        t = 1;
                        break;
                    }
                }
                if (Math.random() > t * (1.0 - GNTPR) + (1 - t) * GNTNR) {
                    G[i][N] = 1;
                    for (j = 0; j < N; ++j) X[i][j]++;
                } else {
                    G[i][N] = 0;
                }
            }
            for (j = 0; j < N; ++j) {
                t = 0;
                for (i = 0; i < N; ++i) {
                    if (G[i][j] == 1) {
                        t = 1;
                        break;
                    }
                }
                if (Math.random() > t * (1.0 - GNTPR) + (1 - t) * GNTNR) {
                    G[N][j] = 1;
                    for (i = 0; i < N; ++i) X[i][j]++;
                } else {
                    G[N][j] = 0;
                }
            }

            for (i = 0; i < N; ++i) {
                t = 0;
                for (j = 0; j < N; ++j) {
                    if (G[(i + j) % N][j] == 1) {
                        t = 1;
                        break;
                    }
                }
                if (Math.random() > t * (1.0 - GNTPR) + (1 - t) * GNTNR) {
                    Diag[i] = 1;
                    for (j = 0; j < N; ++j) X[(i + j) % N][j]++;
                } else {
                    Diag[i] = 0;
                }
            }

            for (i = 0; i < N; ++i) {
                for (j = 0; j < N; ++j) {
                    if (X[i][j] >= 2) {
                        t = G[i][j];
                        N_Test++;
                        if (Math.random() > t * (1.0 - TPR) + (1 - t) * TNR) {
                            H[i][j] = 1;
                        } else {
                            H[i][j] = 0;
                        }
                    } else {
                        H[i][j] = 0;
                    }
                    if (G[i][j] == 1 && H[i][j] == 1) {
                        N_TP++;
                    } else if (G[i][j] == 1 && H[i][j] == 0) {
                        N_TN++;
                    } else if (G[i][j] == 0 && H[i][j] == 1) {
                        N_FP++;
                    } else if (G[i][j] == 0 && H[i][j] == 0) {
                        N_FN++;
                    }
                }
            }
            N_Test += 3 * N;
        }
        if (K == 1) {

            output_grid(3);
        }
        GTTPR = 1.0 * N_TP / (N_TP + N_TN);
        GTTNR = 1.0 * N_FN / (N_FP + N_FN);
        GTRat = 1.0 * N_Test / (N * N * K);
        if (K == 1) {
            s = "Usage Ratio:<br>" + String(N_Test) + "/" + String(N * N * K) + "~" + Math.round(10000.0 * GTRat) / 100.0 + "%"
                + "<br>Sensitivity:<br>" + N_TP + "/" + (N_TP + N_TN) + "~" + Math.round(10000.0 * GTTPR) / 100.0 + "%<br>Specificity:<br>"
                + N_FN + "/" + (N_FP + N_FN) + "~" + Math.round(10000.0 * GTTNR) / 100.0 + "%<br>";
            document.getElementById("opt-GT").innerHTML = s;
        }
        return;
    }
    function Methods_Comparison2() {
        $("#platplot").hide();
        $("#dashboard_new").hide();
        $("#dashboard_compare").hide();
        $("#compare2").show();


        var NCC = document.getElementById("var-NCC").value;
        var NTS = document.getElementById("var-NTS").value;
        var N0, K0;
        K0 = K;
        p = 1.0 * NCC / NTS;
        N0 = Math.round(Math.sqrt(1.0 / p));
        if (N0 < 4) N0 = 4;
        N = N0;
        console.log(p);
        console.log(N);
        var Rat1, TPR1, TNR1, Rat2, TPR2, TNR2, Rat3, TPR3, TNR3;
        var vRat1, vTPR1, vTNR1, vRat2, vTPR2, vTNR2, vRat3, vTPR3, vTNR3;
        N = N0; K = Math.floor(NTS / N / N) + 1; Group_Test_1W(); Rat1 = Math.round(10000.0 * GTRat) / 100 + "%"; TPR1 = Math.round(10000.0 * GTTPR) / 100.0 + "%"; TNR1 = Math.round(10000.0 * GTTNR) / 100.0 + "%";
        vRat1 = GTRat; vTPR1 = GTTPR; vTNR1 = GTTNR;
        N = 10; K = Math.floor(NTS / 100) + 1; Group_Test_2W(); Rat2 = Math.round(10000.0 * GTRat) / 100 + "%"; TPR2 = Math.round(10000.0 * GTTPR) / 100.0 + "%"; TNR2 = Math.round(10000.0 * GTTNR) / 100.0 + "%";
        vRat2 = GTRat; vTPR2 = GTTPR; vTNR2 = GTTNR;
        N = N0; K = Math.floor(NTS / N / N) + 1; Group_Test_3W(); Rat3 = Math.round(10000.0 * GTRat) / 100 + "%"; TPR3 = Math.round(10000.0 * GTTPR) / 100.0 + "%"; TNR3 = Math.round(10000.0 * GTTNR) / 100.0 + "%";
        vRat3 = GTRat; vTPR3 = GTTPR; vTNR3 = GTTNR;
        K = K0;
        var s;
        s = "<p align='center'>" + NCC + " confirmed cases in " + NTS + " tests<br><table class='table table-hover table-bordered'><thead><th align='center'> p = " + Math.round(10000.0 * p) / 100 + "% </th><th align='center'>Usage ratio/Number of tests</th><th align='center'>Sensitivity/missed cases</th><th align='center'>Specificity</th></thead>"
            + "<tbody><tr><td align='center'>Dorfman's pooling</td><td align='center'>" + Rat1 + "/" + Math.round(NTS * vRat1) + "</td><td align='center'>" + TPR1 + "/" + Math.round(NCC * (1 - vTPR1)) + "</td><td align='center'>" + TNR1 + "</td></tr>"
            + "<tr><td align='center'>2-Grid Method</td><td align='center'>" + Rat2 + "/" + Math.round(NTS * vRat2) + "</td><td align='center'>" + TPR2 + "/" + Math.round(NCC * (1 - vTPR2)) + "</td><td align='center'>" + TNR2 + "</td></tr>"
            + "<tr><td align='center'>3-Grid Method (w=" + N0 + ")</td><td align='center'>" + Rat3 + "/" + Math.round(NTS * vRat3) + "</td><td align='center'>" + TPR3 + "/" + Math.round(NCC * (1 - vTPR3)) + "</td><td align='center'>" + TNR3 + "</td></tr>"
            + "</tbody></table></p>";
        document.getElementById("opt-Comp").innerHTML = s;
    }

    function Summary() {
        $("#platplot").hide();
        $("#dashboard_new").show();
        $("#dashboard_compare").hide();
        $("#compare2").hide();


        var maxP = Number(slider_N.max) - 5;
        var p_old = p;
        var i;
        var P_X = new Array(maxP);
        var P_Y1 = new Array(maxP), P_Y2 = new Array(maxP), P_Y3 = new Array(maxP);
        var p_preset = [0.001, 0.002, 0.004, 0.008, 0.01, 0.02, 0.04, 0.08, 0.1, 0.2];

        console.log(p_preset[0]);
        //K = Number(slider_K.max);
        //slider_K.value = K;

        var PXY1 = [], PXY2 = [], PXY3 = [];
        for (i = 0; i < maxP; ++i) {
            //N = i + 5;

            // p = p_preset[i];
            p = 1.0 / (i + 5) / (i + 5);
            P_X[i] = p;//1.0/N/N;
            N = Math.round(Math.sqrt(1.0 / p));
            if (N < 5) N = 5;
            Group_Test();
            P_Y1[i] = GTTPR;
            P_Y2[i] = GTTNR;
            P_Y3[i] = GTRat;
            PXY1.push(
                {
                    x: P_X[i],
                    y: P_Y1[i]
                }
            );
            PXY2.push(
                {
                    x: P_X[i],
                    y: P_Y2[i]
                }
            );
            PXY3.push(
                {
                    x: P_X[i],
                    y: P_Y3[i]
                }
            );

        }
        p = p_old;
        //slider_N.value = N;
        N = Number(slider_N.value);
        //K = Number(slider_K.value);
        plotData(scatterChart, "Sensitivity", PXY1);
        plotData(scatterChart, "Specificity", PXY2);
        plotData(scatterChart, "Usage Ratio", PXY3);
        //document.getElementById("opt-N").innerHTML = N;
        //document.getElementById("opt-K").innerHTML = K;
        return;
    }

    function Methods_Comparison() {
        $("#platplot").hide();
        $("#dashboard_new").hide();
        $("#dashboard_compare").show();
        $("#compare2").hide();


        var maxP = Number(slider_N.max) - 5;
        var p_old = p;
        var i, N0;
        var P_X = new Array(maxP);
        // var P_Y1 = new Array(maxP), P_Y2 = new Array(maxP), P_Y3 = new Array(maxP);
        var p_preset = [0.001, 0.002, 0.004, 0.008, 0.01, 0.02, 0.04, 0.08, 0.1, 0.2];

        console.log(p_preset[0]);
        //K = Number(slider_K.max);
        //slider_K.value = K;

        var PXY11 = [], PXY12 = [], PXY13 = [];
        var PXY21 = [], PXY22 = [], PXY23 = [];
        var PXY31 = [], PXY32 = [], PXY33 = [];
        for (i = 0; i < maxP; ++i) {
            //N = i + 5;

            // p = p_preset[i];
            p = 1.0 / (i + 5) / (i + 5);
            P_X[i] = p;//1.0/N/N;
            N = Math.round(Math.sqrt(1.0 / p));
            if (N < 5) N = 5;
            Group_Test_1W();
            PXY11.push(
                {
                    x: P_X[i],
                    y: GTRat
                }
            );
            PXY21.push(
                {
                    x: P_X[i],
                    y: GTTPR
                }
            );
            PXY31.push(
                {
                    x: P_X[i],
                    y: GTTNR
                }
            );
            //N0 = N;
            //N = 10;
            Group_Test_2W();
            PXY12.push(
                {
                    x: P_X[i],
                    y: GTRat
                }
            );
            PXY22.push(
                {
                    x: P_X[i],
                    y: GTTPR
                }
            );
            PXY32.push(
                {
                    x: P_X[i],
                    y: GTTNR
                }
            );
            //N = N0;
            Group_Test_3W();
            PXY13.push(
                {
                    x: P_X[i],
                    y: GTRat
                }
            );
            PXY23.push(
                {
                    x: P_X[i],
                    y: GTTPR
                }
            );
            PXY33.push(
                {
                    x: P_X[i],
                    y: GTTNR
                }
            );

        }
        p = p_old;
        //slider_N.value = N;
        N = Number(slider_N.value);
        //K = Number(slider_K.value);



        plotData(compareChart[0], "Dorfman", PXY11);
        plotData(compareChart[0], "2-Grid", PXY12);
        plotData(compareChart[0], "3-Grid", PXY13);

        plotData(compareChart[1], "Dorfman", PXY21);
        plotData(compareChart[1], "2-Grid", PXY22);
        plotData(compareChart[1], "3-Grid", PXY23);

        plotData(compareChart[2], "Dorfman", PXY31);
        plotData(compareChart[2], "2-Grid", PXY32);
        plotData(compareChart[2], "3-Grid", PXY33);
        //document.getElementById("opt-N").innerHTML = N;
        //document.getElementById("opt-K").innerHTML = K;
        return;
    }

</script>

</html>